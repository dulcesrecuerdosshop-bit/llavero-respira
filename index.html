<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Frase Motivacional ‚Äî Llavero Respira</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <!-- Styles: global first, card styling, overlay, modal -->
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/frase-card.css">
  <link rel="stylesheet" href="css/overlay-custom.css">
  <link rel="stylesheet" href="css/modal-user.css">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>

<body>
  <!-- Welcome (first run) -->
  <section id="welcome" class="welcome fullscreen hidden">
    <div class="welcome-inner">
      <img src="logo.png" alt="Logo Llavero Respira" class="welcome-logo">
      <h1 class="welcome-title">Llavero Respira</h1>
      <p class="welcome-sub">Un recordatorio amable para respirar y estar presente.</p>
      <button id="welcome-continue" class="btn primary">Continuar</button>
    </div>
  </section>

  <!-- Main view -->
  <main id="main" class="main">
    <header class="app-header">
      <div class="header-left">
        <img src="logo.png" alt="Logo" class="logo" />
        <div class="greeting">
          <div id="appTitle" class="app-title">Llavero Respira</div>
          <div id="user-greeting" class="user-greeting">Un recordatorio amable</div>
        </div>
      </div>
      <button id="menuToggle" class="menu-btn" aria-expanded="false" aria-controls="menuPanel">‚ò∞</button>
    </header>

    <!-- MENU PANEL (global actions) -->
    <div id="menuPanel" class="menu-panel" role="menu" aria-hidden="true" style="display:none;">
      <button id="breathBtn_menu" class="primary" data-action="breath">üå¨Ô∏è Respirar</button>
      <button id="showFavs_menu" data-action="show-favorites">‚≠ê Favoritos</button>
      <button id="shareApp_menu" data-action="share-app">üîó Compartir app</button>
      <hr>
      <button id="enableAudioBtn" data-action="enable-audio">üîà Activar audio</button>
      <button id="settings_menu" data-action="settings">‚öôÔ∏è Ajustes</button>
    </div>

    <section class="panel">
      <!-- Phrase card (big) -->
      <div class="frase-card" id="frase-card" role="region" aria-live="polite">
        <div class="frase-bg" id="frase-bg" aria-hidden="true"></div>
        <div class="frase-content">
          <div id="frase-text" class="frase-text">Cargando...</div>

          <div class="frase-controls" role="toolbar" aria-label="Controles de frase">
            <button id="ttsBtn" class="control" data-action="tts" aria-label="Escuchar">üîä Escuchar</button>
            <button id="favBtn" class="control" data-action="favorite" aria-pressed="false" aria-label="Favorito">‚ô°</button>
            <button id="downloadBtn" class="control" data-action="download" aria-label="Descargar">‚¨áÔ∏è</button>
            <button id="shareBtn" class="control" data-action="share" aria-label="Compartir">üîó</button>
            <!-- inviteBtn intentionally removed -->
          </div>
        </div>
      </div>

      <div class="hint">Toca la tarjeta (fuera de los controles) o presiona ESPACIO para cambiar la frase.</div>
    </section>

    <footer class="app-footer">Gracias por tu apoyo ‚ù§Ô∏è</footer>
  </main>

  <div id="lr-user-modal" class="lr-user-modal hidden" aria-hidden="true"></div>

  <!-- Menu toggle wiring -->
  <script>
    window.LR_DEBUG = window.LR_DEBUG === true;
    document.addEventListener('DOMContentLoaded', () => {
      const toggle = document.getElementById('menuToggle');
      const panel = document.getElementById('menuPanel');
      if (!toggle || !panel) return;
      toggle.addEventListener('click', (e) => {
        const shown = panel.style.display === 'flex' || panel.style.display === 'block';
        panel.style.display = shown ? 'none' : 'flex';
        panel.style.flexDirection = 'column';
        panel.setAttribute('aria-hidden', shown ? 'true' : 'false');
        toggle.setAttribute('aria-expanded', String(!shown));
        if (window.LR_DEBUG) console.log('[ui] menuToggle ->', !shown);
      });
      document.addEventListener('click', (ev) => {
        if (!panel) return;
        if (panel.style.display !== 'none' && !panel.contains(ev.target) && ev.target.id !== 'menuToggle') {
          panel.style.display = 'none';
          panel.setAttribute('aria-hidden', 'true');
          toggle.setAttribute('aria-expanded', 'false');
        }
      });
    });
  </script>

  <!-- Core scripts: helpers first, phrases next -->
  <!-- Apunta a la versi√≥n funcional actual -->
  <script src="js/helpers.v2.js" defer></script>
  <script src="js/phrases.js" defer></script>
  <script src="js/ui-fixes.js" defer></script>
  <script src="js/load-user.js" defer></script>

  <!-- Service worker registration to ensure the new sw.js is active and can update caches -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          // Construir la URL del sw.js relativa a la p√°gina actual (evita '/' ra√≠z accidental)
          const swUrl = new URL('sw.js', location.href).href;

          // Calcular scope: carpeta actual del path (ej. /llavero-respira/)
          let scopePath = '/';
          try {
            const path = location.pathname || '/';
            if (path.endsWith('/')) scopePath = path;
            else scopePath = path.substring(0, path.lastIndexOf('/') + 1) || '/';
          } catch (_) { scopePath = '/'; }

          // Log para depuraci√≥n: comprobar URL y scope que se intentan registrar
          console.log('[sw] attempting to register', swUrl, 'scope=', scopePath);

          // Registrar con scope expl√≠cito para forzar que quede bajo /<repo>/
          const reg = await navigator.serviceWorker.register(swUrl, { scope: scopePath });
          console.log('[sw] registered', reg.scope);

          // Si hay un SW esperando, pedir skipWaiting
          if (reg.waiting) {
            try { reg.waiting.postMessage({ type: 'SKIP_WAITING' }); } catch (e) { /* ignore */ }
          }

          // Recargar cuando el nuevo SW tome el control
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            console.log('[sw] controllerchange -> reloading');
            window.location.reload();
          });
        } catch (e) {
          console.warn('[sw] registration failed', e);
        }
      });
    }
  </script>
</body>
</html>
