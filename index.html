<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Frase Motivacional ‚Äî Llavero Respira</title>

  <link rel="manifest" href="/manifest.json">
  <!-- html2canvas para descargar la pantalla como imagen -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <style>
    :root{
      --text-color: #fff;
      --muted: rgba(255,255,255,0.85);
      --btn-bg: rgba(255,255,255,0.08);
      --btn-radius: 10px;
      --panel: rgba(255,255,255,0.06);
      --accent: #ffd166;
    }
    html,body { height:100%; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-family: 'Arial', sans-serif;
      text-align: center;
      transition: background 0.5s ease;
      padding: 20px;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: var(--text-color);
      -webkit-font-smoothing:antialiased;
    }

    .card {
      width: 100%;
      max-width: 980px;
      padding: 18px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      box-shadow: 0 12px 40px rgba(0,0,0,0.28);
    }

    img.logo {
      max-width: 140px;
      margin-bottom: 18px;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.25));
    }

    .frase {
      font-size: 1.8em;
      color: var(--text-color);
      font-weight: 700;
      max-width: 900px;
      width: 90%;
      line-height: 1.3;
      cursor: pointer;
      transition: transform 0.25s ease, opacity 0.25s ease;
      user-select: none;
      padding: 18px 22px;
      border-radius: 14px;
      backdrop-filter: blur(6px);
      background: var(--panel);
      box-shadow: 0 8px 30px rgba(0,0,0,0.18);
      margin: 8px auto;
    }

    .frase:active { transform: scale(0.99); }

    .hint {
      margin-top: 12px;
      color: var(--muted);
      font-size: 0.92em;
      opacity: 0.95;
    }

    /* Menu / controls */
    .menuBtn{position:fixed; right:16px; top:16px; background:transparent; border:1px solid rgba(255,255,255,0.06); padding:10px; border-radius:12px; color:var(--text-color); z-index:12000; font-size:18px}
    .menuPanel{position:fixed; right:16px; top:58px; background:rgba(0,0,0,0.66); padding:12px; border-radius:12px; backdrop-filter:blur(8px); display:none; flex-direction:column; gap:8px; z-index:12001; min-width:220px; max-height:70vh; overflow:auto}
    .menuPanel button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text-color);padding:8px 10px;border-radius:10px;cursor:pointer;text-align:left}
    .menuPanel .primary{background:var(--accent);color:#222;border:none;font-weight:700}

    /* Modal for favorites */
    ._lr_modal { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:13000; }
    ._lr_modal .box { max-width:760px; width:92%; max-height:72vh; overflow:auto; background: rgba(255,255,255,0.03); color:#fff; padding:16px; border-radius:12px; }

    footer{position:fixed; left:18px; bottom:18px; color:var(--muted); font-size:0.85rem}
    @media (max-width:560px){
      .frase { font-size:1.2em; padding:14px; }
      .menuBtn{right:10px;top:10px}
      .menuPanel{right:10px;top:50px}
    }
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="appTitle">
    <header style="display:flex;align-items:center;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:12px">
        <img src="logo.png" alt="Logo Llavero Respira" class="logo" />
        <div>
          <div id="appTitle" style="font-weight:700">Llavero Respira</div>
          <div style="color:var(--muted);font-size:0.9rem">Un recordatorio amable</div>
        </div>
      </div>
    </header>

    <div id="frase" class="frase" role="button" aria-pressed="false" title="Toca para ver otra frase"></div>
    <div class="hint">Toca la frase o presiona espacio para cambiar. Usa el men√∫ (‚ò∞) para opciones.</div>

    <footer>Gracias por tu apoyo ‚ù§Ô∏è</footer>
  </div>

  <!-- Menu hamburger -->
  <button id="menuToggle" class="menuBtn" aria-expanded="false" aria-controls="menuPanel">‚ò∞</button>
  <div id="menuPanel" class="menuPanel" role="menu" aria-hidden="true">
    <button id="favBtn_menu">‚ô° Favorita</button>
    <button id="shareBtn_menu">üîó Compartir</button>
    <button id="copyBtn_menu">üìã Copiar</button>
    <button id="ttsBtn_menu">üîä Escuchar (TTS)</button>
    <button id="startAmbientBtn">‚ñ∂ Ambient</button>
    <button id="stopAmbientBtn">‚è∏ Ambient</button>
    <button id="breathBtn_menu" class="primary">üå¨Ô∏è Respirar</button>
    <button id="downloadBtn_menu">‚¨áÔ∏è Descargar</button>
    <hr style="opacity:.08;margin:8px 0">
    <button id="showFavoritesBtn">‚≠ê Favoritos</button>
    <button id="enableAudioBtn">üîà Activar audio</button>
  </div>

  <!-- helpers.v2.js primero -->
  <script src="js/helpers.v2.js" defer></script>

  <script defer>
    // --- PHRASES (mantenidas igual que tu versi√≥n) ---
    const frases = [
      "Cree en ti y todo ser√° posible.",
      "Un paso hoy vale m√°s que cien promesas ma√±ana.",
      "La constancia vence lo que la suerte no alcanza.",
      "Lo √∫nico imposible es aquello que no intentas.",
      "Si caes, lev√°ntate con m√°s fuerza y sabidur√≠a.",
      "El √©xito es la suma de peque√±os esfuerzos repetidos.",
      "Hazlo con pasi√≥n o no lo hagas.",
      "Tu futuro lo construyes con las decisiones de hoy.",
      "No temas al error: es el comienzo del aprendizaje.",
      "Transforma los problemas en oportunidades.",
      "Avanza aunque sea despacio; avanzar es avanzar.",
      "Cada d√≠a es una nueva p√°gina: escribe algo valioso.",
      "El miedo frena, la acci√≥n impulsa.",
      "Aprende, adapta, mejora y repite.",
      "No esperes el momento perfecto; cr√©alo.",
      "La disciplina supera al talento cuando el talento no se esfuerza.",
      "Tu actitud determina tu direcci√≥n.",
      "Enf√≥cate en soluciones, no en excusas.",
      "La perseverancia abre puertas que parec√≠an cerradas.",
      "Lo que hoy parece dif√≠cil ser√° ma√±ana rutina.",
      "Si buscas resultados distintos, prueba acciones distintas.",
      "Rod√©ate de quienes te inspiren a crecer.",
      "No te compares; compite con tu yo del ayer.",
      "La gratitud multiplica lo que ya tienes.",
      "Si fallas, es porque te atreviste a intentar algo grande.",
      "Cada logro comienza con la decisi√≥n de intentar.",
      "Mant√©n la calma y sigue hacia adelante.",
      "Tu esfuerzo es la inversi√≥n que paga en futuro.",
      "Cambia el ‚Äúno puedo‚Äù por ‚Äúvoy a intentarlo‚Äù.",
      "Lo √∫nico que necesitas para empezar es empezar.",
      "La paciencia es la compa√±era de los grandes √©xitos.",
      "No renuncies antes de ver los frutos de tu trabajo.",
      "Vive con intenci√≥n y act√∫a con prop√≥sito.",
      "La creatividad nace cuando te permites equivocarte.",
      "Agradece lo peque√±o: es semilla de lo grande.",
      "Si te caes siete veces, lev√°ntate ocho.",
      "La mayor barrera est√° entre tus o√≠dos; derr√≠bala.",
      "Trabaja en silencio; deja que el √©xito haga ruido.",
      "Hoy planta lo que ma√±ana te dar√° sombra.",
      "No dejes que la duda robe tus oportunidades.",
      "Cada d√≠a es otra chance para mejorar.",
      "El progreso es mejor que la perfecci√≥n estancada.",
      "Cree en tu proceso aunque no veas el mapa completo.",
      "La acci√≥n es el puente entre tus sue√±os y la realidad.",
      "S√© valiente: lo grande se gana fuera de la zona de confort.",
      "Tu historia no termina con un tropiezo; contin√∫a.",
      "Lo que haces hoy determina c√≥mo te sentir√°s ma√±ana.",
      "El esfuerzo silencioso construye el √©xito visible.",
      "Acepta el cambio; en √©l est√° la oportunidad.",
      "No busques la aprobaci√≥n; busca la mejora.",
      "Haz de cada obst√°culo una lecci√≥n aprendida.",
      "El √©xito durable se forja con integridad y constancia.",
      "Vive con intenci√≥n, trabaja con disciplina, celebra con humildad.",
      "El talento se pule con trabajo, no con excusas.",
      "No te detengas hasta sentirte orgulloso.",
      "Menos quejarse, m√°s solucionar.",
      "Siembra h√°bitos hoy para cosechar tu mejor versi√≥n.",
      "Enf√≥cate en el proceso; los resultados vendr√°n.",
      "Tu potencial es mayor de lo que piensas; afl√≥ralo.",
      "Aprovecha el presente: es el √∫nico tiempo que controlas.",
      "La confianza se gana acciones tras acci√≥n.",
      "Lo dif√≠cil es temporal; el orgullo es permanente.",
      "Persigue progreso, no perfecci√≥n.",
      "Cuando otros duden, mu√©strate constante.",
      "Un logro a la vez construye grandes metas.",
      "Aprende a descansar sin renunciar a tus metas.",
      "No temas a los comienzos; son oportunidades disfrazadas.",
      "La mejor inversi√≥n es la que haces en ti mismo.",
      "Siembra esfuerzo hoy, recoge libertad ma√±ana.",
      "Ve m√°s all√° de lo que te imaginaste posible.",
      "Rod√©ate de acciones, no de promesas.",
      "Cada peque√±o avance suma un gran cambio.",
      "La disciplina forja el car√°cter y el destino.",
      "Mant√©n la visi√≥n cuando el camino sea oscuro.",
      "Conf√≠a en tu capacidad de adaptarte y superar.",
      "El √©xito no es suerte; es trabajo bien orientado.",
      "La pasi√≥n enciende, la perseverancia mantiene.",
      "Celebra los peque√±os triunfos; motivan los grandes.",
      "Enf√≥cate en lo que puedes controlar y suelta lo dem√°s.",
      "Las metas sin plan quedan en deseo; planifica y act√∫a.",
      "Si quieres resultados distintos, cambia tus h√°bitos.",
      "Lo que te limita hoy puede inspirarte ma√±ana.",
      "Habla menos; muestra m√°s con tus actos.",
      "El coraje no es ausencia de miedo, es actuar a pesar de √©l.",
      "Mant√©n la mente abierta y el compromiso firme.",
      "Sue√±a en grande, empieza en peque√±o, crece constante.",
      "No te rindas: las historias m√°s grandes tienen cap√≠tulos dif√≠ciles.",
      "Aprende a agradecer el proceso, no solo el resultado.",
      "La resiliencia te hace m√°s fuerte que las circunstancias.",
      "Piensa en grande, act√∫a con persistencia y humildad.",
      "Lo que hoy es esfuerzo, ma√±ana ser√° costumbre.",
      "Construye h√°bitos que te acerquen a tus sue√±os.",
      "Siembra disciplina y cosechar√°s libertad.",
      "Pon intenci√≥n en lo que haces y calidad en c√≥mo lo haces.",
      "Cada d√≠a es una nueva oportunidad para reinventarte.",
      "No busques atajos; construye cimientos s√≥lidos.",
      "El cambio empieza cuando decides dejar de esperar.",
      "Tu actitud hoy crea tus oportunidades de ma√±ana.",
      "S√© la raz√≥n por la que alguien m√°s no se rinde.",
      "Vive con prop√≥sito, trabaja con constancia y ama el camino."
    ];

    const fondos = [
      "linear-gradient(135deg, #f6d365, #fda085)",
      "linear-gradient(135deg, #a1c4fd, #c2e9fb)",
      "linear-gradient(135deg, #84fab0, #8fd3f4)",
      "linear-gradient(135deg, #fccb90, #d57eeb)",
      "linear-gradient(135deg, #f093fb, #f5576c)",
      "linear-gradient(135deg, #6a11cb, #2575fc)",
      "linear-gradient(135deg, #43cea2, #185a9d)",
      "linear-gradient(135deg, #ff9a9e, #fecfef)",
      "linear-gradient(135deg, #a18cd1, #fbc2eb)",
      "linear-gradient(135deg, #30cfd0, #330867)"
    ];

    const fraseEl = document.getElementById('frase');

    function mostrarFrase() {
      const fraseIndex = Math.floor(Math.random() * frases.length);
      const fondoIndex = Math.floor(Math.random() * fondos.length);
      fraseEl.style.opacity = 0;
      setTimeout(() => {
        const texto = frases[fraseIndex];
        fraseEl.textContent = texto;
        document.body.style.background = fondos[fondoIndex];
        fraseEl.style.opacity = 1;
        // Notificar a helpers (si existe) para historial/favoritos
        if (typeof window.onFraseMostrada === 'function') window.onFraseMostrada(texto);
      }, 180);
    }

    // Mostrar una al cargar (helpers.v2.js ya se ha cargado antes por defer)
    mostrarFrase();

    // Interacciones
    fraseEl.addEventListener('click', mostrarFrase);
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') { e.preventDefault(); mostrarFrase(); }
    });

    // Menu UI wiring
    document.addEventListener('DOMContentLoaded', () => {
      const menuToggle = document.getElementById('menuToggle');
      const menuPanel = document.getElementById('menuPanel');

      // Toggle menu
      menuToggle.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const shown = menuPanel.style.display === 'flex';
        menuPanel.style.display = shown ? 'none' : 'flex';
        menuPanel.setAttribute('aria-hidden', shown ? 'true' : 'false');
        menuToggle.setAttribute('aria-expanded', String(!shown));
      });

      // Close menu on outside click
      document.addEventListener('click', (ev) => {
        const panel = document.getElementById('menuPanel');
        if (!panel) return;
        if (panel.style.display === 'flex' && !panel.contains(ev.target) && ev.target.id !== 'menuToggle') {
          panel.style.display = 'none';
          menuToggle.setAttribute('aria-expanded', 'false');
          panel.setAttribute('aria-hidden', 'true');
        }
      });

      // Close menu when user selects an option (but let the helper handler run first)
      menuPanel.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button');
        if (!btn) return;
        setTimeout(() => {
          menuPanel.style.display = 'none';
          menuToggle.setAttribute('aria-expanded', 'false');
          menuPanel.setAttribute('aria-hidden', 'true');
        }, 80);
      });

      // Delegate menu buttons to helpers.js where possible
      const bind = (id, fnName) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('click', async (ev) => {
          ev.stopPropagation();
          const text = document.getElementById('frase')?.textContent || '';
          if (window.lr_helpers && typeof window.lr_helpers[fnName] === 'function') {
            try {
              // pass current phrase where applicable
              if (fnName === 'toggleFavorite') { window.lr_helpers.toggleFavorite(text); }
              else if (fnName === 'playTTS') { window.lr_helpers.playTTS ? window.lr_helpers.playTTS(text) : (function(){ if ('speechSynthesis' in window) { const u=new SpeechSynthesisUtterance(text); speechSynthesis.speak(u); } })(); }
              else { await window.lr_helpers[fnName](); }
            } catch (e) { console.warn(e); }
          } else {
            // small fallbacks
            if (fnName === 'startBreathFlow' || fnName === 'playInhale') { mostrarFrase(); }
            if (fnName === 'startAmbient') { window.lr_helpers && window.lr_helpers.startAmbient && window.lr_helpers.startAmbient(); }
            if (fnName === 'copyToClipboard') { copyToClipboard(text); }
            if (fnName === 'showFavorites') { showFavoritesFallback(); }
          }
        });
      };

      bind('favBtn_menu', 'toggleFavorite');
      bind('shareBtn_menu', 'share'); // optional
      bind('copyBtn_menu', 'copyToClipboard');
      bind('ttsBtn_menu', 'playTTS');
      bind('startAmbientBtn', 'startAmbient');
      bind('stopAmbientBtn', 'stopAmbient');
      bind('breathBtn_menu', 'startBreathFlow');
      bind('downloadBtn_menu', 'downloadImage');
      bind('showFavoritesBtn', 'showFavorites');

      // Enable audio explicit user gesture
      const enableAudioBtn = document.getElementById('enableAudioBtn');
      enableAudioBtn && enableAudioBtn.addEventListener('click', async (ev) => {
        ev.stopPropagation();
        if (window.lr_helpers && typeof window.lr_helpers.resumeAudio === 'function') {
          const s = await window.lr_helpers.resumeAudio();
          console.log('resumeAudio ->', s);
          alert('Intentado activar audio (si el navegador lo permite).');
          return;
        }
        // fallback: small silent audio to unlock
        try {
          const a = new Audio();
          a.src = 'data:audio/mp3;base64,//uQZAAAAAAAAAAAAAA...'; // tiny silent base64 (may be blocked); fallback just informs
          await a.play().catch(()=>{});
          alert('Intentado activar audio. Pulsa "Respirar" si no se oye.');
        } catch (e) { alert('Intento de activar audio realizado.'); }
      });

      // Keyboard shortcut: ctrl/cmd + B -> breath
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'b') {
          document.getElementById('breathBtn_menu')?.click();
        }
      });
    });

    // --- Helpers used by this index (fallbacks if helpers.js lacks implementations) ---
    function copyToClipboard(text) {
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(text).then(()=> alert('Frase copiada'));
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); alert('Frase copiada'); } catch (e) { console.warn(e); alert('No se pudo copiar'); }
      ta.remove();
    }

    async function downloadImage() {
      try {
        const el = document.querySelector('.card') || document.body;
        const canvas = await html2canvas(el, { scale: window.devicePixelRatio || 2 });
        const url = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url;
        a.download = 'llavero-respira-frase.png';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (e) {
        console.warn('downloadImage error', e);
        alert('No se pudo descargar la imagen en este navegador.');
      }
    }

    // Fallback show favorites if helpers not present
    function showFavoritesFallback() {
      try {
        const raw = localStorage.getItem('lr_favoritos_v1') || '[]';
        const favs = JSON.parse(raw);
        const modal = document.createElement('div');
        modal.className = '_lr_modal';
        const box = document.createElement('div');
        box.className = 'box';
        box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>Favoritos</strong><button id="_lr_close_fav" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:8px">Cerrar</button></div><hr style="opacity:.08;margin:8px 0">`;
        if (!favs || !favs.length) box.innerHTML += '<div style="color:rgba(255,255,255,0.8)">No hay favoritos</div>';
        else box.innerHTML += favs.map(f => `<div style="margin:10px 0;line-height:1.3">${escapeHtml(f)}</div>`).join('');
        modal.appendChild(box);
        document.body.appendChild(modal);
        document.getElementById('_lr_close_fav').addEventListener('click', () => modal.remove());
      } catch (e) { console.warn('showFavoritesFallback', e); alert('No hay favoritos'); }
    }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Provide compatibility wrappers used earlier
    window.lr_index_helpers = {
      copyToClipboard,
      downloadImage,
      showFavoritesFallback
    };

    // Safe registration of service worker (unchanged)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        fetch('sw.js', { method: 'HEAD' })
          .then(resp => {
            if (resp.ok) {
              navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registrado:', reg))
                .catch(err => console.warn('SW registro fall√≥:', err));
            } else {
              console.log('sw.js no disponible (HEAD):', resp.status);
            }
          })
          .catch(err => console.log('sw.js no encontrado o error de red:', err));
      });
    }
  </script>
  <script src="js/load-user.js" defer></script>
</body>
</html>
